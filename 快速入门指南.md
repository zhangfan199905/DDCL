# DDCL项目快速入门指南

## 项目简介

本项目实现了基于SUMO交通仿真平台的动态CAV（网联自动驾驶车辆）专用道管理系统。系统能够智能管理高速公路上的CAV专用道，优化交通流、安全性和吞吐量。

## 文件说明

### 已创建的SUMO仿真文件

所有SUMO配置文件位于 `V1.6/scenario/` 目录：

1. **test.sumocfg** - SUMO主配置文件
   - 仿真的入口文件
   - 引用所有其他配置文件
   - 设置仿真时间、步长和输出选项

2. **net.net.xml** - 路网定义文件
   - 高速公路几何结构（总长4000米）
   - 14条边（路段），车道数量不同
   - 路口定义和连接关系
   - 车道属性（宽度、限速、允许车辆类别）

3. **rou.rou.xml** - 路径和车辆流文件
   - 车辆流量定义
   - 发车速率和时间
   - 路径分配（起点-终点）

4. **vTypeDistributions.add.xml** - 车辆类型参数文件
   - HV（人工驾驶车辆）特性
   - CAV（网联自动驾驶车辆）特性
   - 混合交通分布（67% HV，33% CAV）

5. **det.add.xml** - 检测器配置文件（已存在）
   - 每个路段的车道检测器
   - 数据收集频率（60秒）
   - 输出文件规范

6. **viewsettings.xml** - SUMO-GUI可视化设置
   - 仿真可视化的显示偏好设置
   - 摄像机位置和缩放级别
   - 车辆和车道渲染选项

## 路网结构

```
边布局（总长约3984米）：
┌────────────────────────────────────────────────────────────────┐
│  上游区    │        控制区（10个路段）            │ 瓶颈区 │ 下游 │
│   1000米   │        1996米（9×200米+196米）        │ 292米  │ 696米│
├────────────┼──────────────────────────────────────┼────────┼──────┤
│  边1       │ 边2-11（动态控制区域）                │边12    │边13  │
│  3车道     │ 3车道（车道0为可控车道）              │2车道   │3车道 │
└────────────┴──────────────────────────────────────┴────────┴──────┘

注：边11为196米（略短），以适应总网络长度。

车道分配：
  车道2（左侧）：  [═════ 普通混合交通 ═════════]
  车道1（中间）：  [═════ 缓冲/过渡车道 ═════════]
  车道0（右侧）：  [═════ 可控车道（CDL/HML/RML）═]
```

## 车辆类型

### HV（人工驾驶车辆）- 车辆类别：custom1
- **反应时间（tau）**：1.21秒（人类感知-反应时间）
- **驾驶员不完美性（sigma）**：0.5（中等变异性）
- **加速度**：2.6 m/s²（典型乘用车）
- **减速度**：4.5 m/s²（舒适制动）
- **最高速度**：120 km/h（33.33 m/s）
- **车长**：5.0米，**车宽**：1.8米

### CAV（网联自动驾驶车辆）- 车辆类别：custom2
- **反应时间（tau）**：0.5秒（传感器处理延迟）
- **驾驶员不完美性（sigma）**：0.0（完美控制）
- **加速度**：3.0 m/s²（增强能力）
- **减速度**：4.5 m/s²（与HV相同以保证安全）
- **最高速度**：120 km/h（33.33 m/s）
- **车长**：5.0米，**车宽**：1.8米

## 安装步骤

### 方法1：使用自动化脚本（推荐）

```bash
# 运行设置脚本
./setup.sh
```

这个脚本会：
1. 检查Python和pip安装
2. 安装Python依赖（traci, numpy, pandas等）
3. 检查SUMO安装
4. 验证配置文件
5. 提供下一步指导

### 方法2：手动安装

#### 1. 安装SUMO

**Ubuntu/Debian系统：**
```bash
sudo add-apt-repository ppa:sumo/stable
sudo apt-get update
sudo apt-get install sumo sumo-tools sumo-doc
```

**设置SUMO_HOME环境变量：**
```bash
export SUMO_HOME=/usr/share/sumo
# 将上面这行添加到 ~/.bashrc 使其永久生效
echo 'export SUMO_HOME=/usr/share/sumo' >> ~/.bashrc
source ~/.bashrc
```

**验证SUMO安装：**
```bash
sumo --version
which sumo
echo $SUMO_HOME
```

#### 2. 安装Python依赖

```bash
pip3 install traci numpy pandas matplotlib jupyter
```

#### 3. 验证配置

```bash
python3 validate_sumo_config.py
```

## 运行仿真

### 方法1：使用Python控制器（推荐）

```bash
cd V1.6/controller
python3 main.py
```

这个脚本会：
1. 使用TraCI接口启动SUMO
2. 初始化车道和车辆控制器
3. 应用动态控制策略
4. 运行2100秒仿真
5. 生成输出文件

### 方法2：使用SUMO-GUI测试

仅测试路网（无动态控制）：
```bash
cd V1.6/scenario
sumo-gui -c test.sumocfg
```

### 方法3：命令行SUMO（批处理）

```bash
cd V1.6/scenario
sumo -c test.sumocfg --no-warnings
```

## 配置选项

编辑 `V1.6/controller/main.py` 更改控制模式：

```python
# 第41行 - 修改这个值：
CURRENT_CONTROL_MODE = MODE_CUSTOM  # 选项：MODE_NO_CONTROL, MODE_BASELINE, MODE_CUSTOM

# 第44-45行 - 调整策略参数：
FIXED_POLICY_M = 5  # CDL长度（路段数）
FIXED_POLICY_N = 5  # HML/缓冲区长度（路段数）
```

### 控制模式说明

1. **MODE_NO_CONTROL (0)**: 
   - 混行交通，无专用道
   - SUMO默认LC2013换道模型
   - 基准对比实验

2. **MODE_BASELINE (1)**:
   - 固定专用道策略
   - SUMO默认LC2013换道模型
   - 静态专用道对比实验

3. **MODE_CUSTOM (2)**:
   - 动态专用道
   - 自定义四阶段换道框架
   - 主要实验模式

## 修改参数

### 修改交通需求

编辑 `V1.6/scenario/rou.rou.xml`：
```xml
<flow id="flow_main" ... vehsPerHour="新值"/>
```

### 修改CAV渗透率

编辑 `V1.6/scenario/vTypeDistributions.add.xml`：
```xml
<vType id="hv" probability="0.5"/>   <!-- 50% HV -->
<vType id="cav" probability="0.5"/>  <!-- 50% CAV -->
```

### 修改仿真时长

编辑 `V1.6/scenario/test.sumocfg`：
```xml
<time>
    <end value="3000"/>  <!-- 从2100改为3000秒 -->
</time>
```

## 输出文件

仿真完成后会生成以下文件（在 `V1.6/scenario/` 目录）：

1. **e2_lane_output.xml** - 检测器数据
   - 交通流量测量
   - 速度、占有率和吞吐量数据
   - 时间序列性能指标

2. **fcdTrajectories.xml** - 车辆轨迹数据
   - 各车辆随时间的位置
   - 速度和加速度曲线
   - 换道事件

3. **lanechanges.xml** - 换道事件
   - 所有换道操作
   - 时间戳和位置
   - 车辆ID和类型

## 数据分析

使用Jupyter Notebook分析结果：

```bash
cd V1.6/analysis
jupyter notebook run_comparison.ipynb
```

分析指标包括：
- **吞吐量（Throughput）**：车辆总行驶距离
- **平均速度（Average Speed）**：所有车辆平均速度
- **安全性（Safety）**：平均2D-TTC值
- **行程时间（Travel Time）**：端到端行驶时间

## 常见问题

### 1. "SUMO_HOME未设置"错误

```bash
export SUMO_HOME=/usr/share/sumo
echo 'export SUMO_HOME=/usr/share/sumo' >> ~/.bashrc
```

### 2. "TraCI连接失败"

- 确保SUMO二进制文件在PATH中
- 检查端口8813未被占用
- 验证sumocfg文件存在

### 3. "vType未找到"错误

- 确认vTypeDistributions.add.xml已加载
- 检查车辆类别名称（custom1/custom2）

### 4. 仿真崩溃

- 查看test.sumocfg中的碰撞设置
- 检查网络连通性
- 验证路径有效性

### 5. 启用调试模式

在 `main.py` 中修改：
```python
sumo_cmd = [
    ...
    "--verbose", "true",
    "--log", "sumo.log"
]
```

## 项目结构

```
DDCL/
├── README.md              # 项目总体说明（中英文）
├── setup.sh               # 自动化设置脚本
├── validate_sumo_config.py # 配置验证脚本
│
└── V1.6/
    ├── scenario/          # SUMO仿真文件
    │   ├── README.md     # 场景文件详细说明
    │   ├── test.sumocfg  # 主配置文件
    │   ├── net.net.xml   # 路网定义
    │   ├── rou.rou.xml   # 路径和流量
    │   ├── vTypeDistributions.add.xml  # 车辆类型
    │   ├── det.add.xml   # 检测器
    │   └── viewsettings.xml  # GUI设置
    │
    ├── controller/        # Python控制系统
    │   ├── main.py       # 主运行脚本
    │   ├── config.py     # 配置参数
    │   ├── controllers/  # 控制器
    │   │   ├── lane_manager.py      # 车道管理
    │   │   └── vehicle_controller.py # 车辆控制
    │   └── environment/  # 强化学习环境
    │       ├── dcdl_env.py          # GMARL环境
    │       ├── reward_calculator.py # 奖励计算
    │       └── twod_ttc_calculator.py # 安全指标
    │
    └── analysis/          # 结果分析
        ├── run_comparison.ipynb  # 对比实验笔记本
        └── result_*.csv         # 性能指标数据
```

## 技术支持

如有问题，请参考：

1. **项目文档**
   - README.md - 总体说明
   - V1.6/scenario/README.md - SUMO文件详解

2. **SUMO官方文档**
   - 主页：https://sumo.dlr.de/docs/
   - TraCI接口：https://sumo.dlr.de/docs/TraCI/
   - 车辆类型：https://sumo.dlr.de/docs/Definition_of_Vehicles,_Vehicle_Types,_and_Routes.html

3. **运行验证脚本**
   ```bash
   python3 validate_sumo_config.py
   ```

## 下一步

1. ✅ 已完成SUMO仿真基础设施搭建
2. ✅ 已创建完整的配置文件
3. ✅ 已添加详细文档
4. 📋 建议运行完整仿真测试
5. 📋 建议调整参数进行对比实验
6. 📋 建议使用分析笔记本评估性能

祝使用愉快！
